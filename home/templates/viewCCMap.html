{% extends 'base_map_1.html' %}
{% load static%} {% block content %}
<style>
    table,
    th,
    td {
        border-bottom: 1px solid #ddd;
        border-collapse: collapse;
        padding: 2px 3px;
        text-align: center;
    }

    th {
        font-weight: bold;
    }

    tr:hover {
        background-color: #c9dbe6;
    }

    #checkboxes {
        display: none;
        /* border: 1px #dadada solid; */
    }

    .slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 25px;
        background: #D3D3D3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }

    .slider:hover {
        opacity: 1;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #FF0000;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #FF0000;
        cursor: pointer;
    }

    .sliderticks {
        display: flex;
        justify-content: space-between;
        padding: 0 10px;
    }

    .sliderticks p {
        position: relative;
        display: flex;
        justify-content: center;
        text-align: center;
        width: 1px;
        background: #D3D3D3;
        height: 10px;
        line-height: 40px;
        margin: 0 0 20px 0;
    }

    input[type="range"]::-moz-range-track {
        padding: 0 10px;
        background: repeating-linear-gradient(to right, #ccc, #ccc 10%, #000 10%, #000 11%, #ccc 11%, #ccc 20%);
    }

    #checkboxes3 label {
        display: block;
        text-align: left;
        margin: 10px;
    }

    #checkboxes3 {
        display: none;
        /* border: 1px #dadada solid; */
    }

    #checkboxes label {
        display: block;
        text-align: left;
        margin: 10px;
    }
    /* #checkboxes label:hover {
  background-color: #1e90ff;
} */

    #checkboxes2 label {
        display: block;
        text-align: left;
        margin: 10px;
    }

    #checkboxes2 {
        display: none;
        /* border: 1px #dadada solid; */
    }

    .btn {
        margin: 10px;
    }

    .border {
        padding: 6px 8px;
        border-style: groove;
        border-radius: 5px;
        margin: 20px;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .table {
        border-collapse: collapse;
        padding: 50px;
        font-weight: bold;
        /* background:rgba(191, 149, 233, 0.473); */
    }
    /* css to customize Leaflet default styles  */

    .leaflet-popup-content-wrapper {
        background: rgba(0, 0, 0, 0.9);
        color: #ffffff;
    }

    .leaflet-popup-content {
        font-weight: bold;
    }

    h6 {
        color: blue;
    }

    .select {
        background-color: rgb(116, 109, 109);
        width: 40%;
        margin-left: 100px;
        ;
        color: white;
    }

    .select.highlight {
        background: rgb(0, 0, 0);
        color: white;
    }

    .circle {
        background-color: red;
        border-radius: 50%;
    }

    .table-legend {
        border-collapse: collapse;
        padding: 2px 3px;
        width: 100%;
        font-size: small;
        /* font-weight: bold; */
        background: #fff;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
    .leaflet-popup-content-wrapper{
        background: white;
    }
</style>

<div id="side-bar" style="background-color: rgba(255, 255, 255);">

    <div class="mobileShow">

        <div style="text-align: center">
            <button style="display: inline-block ;position: relative; background: #000; opacity: 0.60;" id="closebutton" name="closebutton" class="btn btn-secondary"><span class="fa fa-bars"></span></button>
        </div>

    </div>
    {% csrf_token %}
    <form id="cc_form" action="ccmap" method="POST">

    <div class="border">

        <div class="tooltips" title="Please select the District">
            <select onchange="replot(); document.getElementById('plot').click()" name="district" class='form-control mb-2 mt-2' id = "district">
            <option value=""> Select District</option>
            <option value="Ahmednagar">Ahmednagar</option>
            <option value="Akola">Akola</option>
            <option value="Amravati">Amravati</option>
            <option value="Aurangabad">Aurangabad</option>
            <option value="Beed">Beed</option>
            <option value="Bhandara">Bhandara</option>
            <option value="Buldhana">Buldhana</option>
            <option value="Chandrapur">Chandrapur</option>
            <option value="Gadchiroli">Gadchiroli</option>
            <option value="Gondia">Gondia</option>
            <option value="Hingoli">Hingoli</option>
            <option value="Jalgaon">Jalgaon</option>
            <option value="Jalna">Jalna</option>
            <option value="Kolhapur">Kolhapur</option>
            <option value="Latur">Latur</option>
            <option value="Mumbai City">Mumbai City</option>
            <option value="mumbai_suburb">Mumbai Suburban</option>
            <option value="Nagpur">Nagpur</option>
            <option value="Nanded">Nanded</option>
            <option value="Nashik">Nashik</option>
            <option value="Osmanabad">Osmanabad</option>
            <option value="Palghar">Palghar</option>
            <option value="Parbhani">Parbhani</option>
            <option value="Pune">Pune</option>
            <option value="Raigad">Raigad</option>
            <option value="Ratnagiri">Ratnagiri</option>
            <option value="Sangli">Sangli</option>
            <option value="Satara">Satara</option>
            <option value="Sindhudurg">Sindhudurg</option>
            <option value="Solapur">Solapur</option>
            <option value="Thane"> Thane</option>
            <option value="Wardha">Wardha</option>
            <option value="Washim">Washim</option>
            <option value="Yavatmal">Yavatmal</option>
             </select>
        </div>

        

        <hr>
        <label>Facilities</label><br>
        <label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="child_care" id=""> Child Care Institutes </label><br>
        <label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="jjb" id=""> Justice Juvenile Board</label><br>
        <label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="cwc"  id=""> Child Welfare Center </label><br>
        <label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="ak" id=""> Abhay Kendra</label><br>
        <label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="dcpo" id=""> DCPO </label><br>
        <label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="saa" id=""> Special Adoption Agency</label><br>

        <hr><label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="mh_police" id=""> Police Stations</label><br>
        <!-- <hr><label style="margin: 10px;" for=""><input class="optn" onchange="replot(); document.getElementById('plot').click()" type="checkbox" name="mh_police" id="">Police Stations</label><br> -->
        
        <!-- <hr><label style="margin: 10px;" for=""><input class="optn" onchange="plot_police_stations()" type="checkbox" name="mumbai_police_station" id="mumbai_police_station"> Police Stations</label><br> -->
        <!-- <label style="margin: 10px;" for=""><input class="optn" onchange="plot_police_jurisdiction()" type="checkbox" name="mumbai_police_jurisdiction" id="mumbai_police_jurisdiction"> Mumbai Police Stations Jurisdiction</label><br> -->


        <button id="plot" style="display: none;" type="submit">Plot</button>
    </div>
    <div class="border"><label>Clear Selection </label><br>
    
        <button onclick="clearAll()" id="clear-data"class="btn btn-primary" style="align-items: center;">Clear All</button>
    </div>  

    <div class="border"><label>Proximity of Facilities</label><br>
        <button type="button" class="btn-sm btn-primary" id='locate'>Your Location</button>
        <button type="button" class="btn-sm btn-primary" id='setlocation'>Set Location</button>
        <!-- <button type="button" class="btn btn-primary" id='find-nearest'>Find Nearest Facility</button> -->
        <div id="slider">
            <label>Set Range</label><br>
            <input type="range" min="1" max="50" value="1" class="slider" id="myRange" step="1">
            <div class="sliderticks">
                <p>1</p>
                <p>5</p>
                <p>10</p>
                <p>15</p>
                <p>20</p>
                <p>25</p>
                <p>30</p>
                <p>35</p>
                <p>40</p>
                <p>50</p>
            </div>
                <button type="button" class="btn btn-primary" id='setbuffer'>Facilities within <span id="demo"></span> Km </button>
    
</form>
<script>

    var p_plotted=false
    function plot_police_stations(){
        if(!p_plotted){
            var wms_layer;
            ppoints=[]
            var data = fetchJSON("{% static 'data/Point_polie_Station_v1.geojson' %}")
            .then(function(data) { 
        
            // do what you want to do with `data` here...
                data.features.forEach(e => {
                    wms_layer = L.marker([e.geometry.coordinates[1],e.geometry.coordinates[0]],{icon: icon7})
                    wms_layer.addTo(mymap)
                    htm=""
                    for (const key in e.properties) {
                        if (e.properties.hasOwnProperty(key)) {
                        htm = htm+`${key}: ${e.properties[key]}<br>`
                        }
                    }
                    wms_layer.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`</div>`)
                    ppoints.push(wms_layer)
                });
            
            }); 
            p_plotted=true;
        }else{
            ppoints.forEach(e=>{
                mymap.removeLayer(e)
            })
            p_plotted=false
        }
          
    }

    var pj_plotted=false;
    var wms_layer;
    function plot_police_jurisdiction(){
        if(!pj_plotted){
        var data = fetchJSON("{% static 'data/police_jurisdiction.geojson' %}")
        .then(function(data) { 
    
        // do what you want to do with `data` here...
        wms_layer = L.geoJson(data)
        wms_layer.addTo(mymap)
        mymap.fitBounds(wms_layer.getBounds())

        });   
        pj_plotted=true;
        }else{
            wms_layer.remove()
            pj_plotted=false
        }
    }

</script>

    
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>


    var points=[];
    var districtLayer;
    var talLayer;

    
    var legend = L.control({position: 'topright'});

legend.onAdd = function (mymap) {

    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 10, 20, 50, 100, 200, 500, 1000],
        labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
    
        div.innerHTML +=`<img src="{% static 'map/pinmargerblue.png' %}" style="width:28px;height:28px;"> Child Care <br>
        <img src="{% static 'map/pinmargerred.png' %}" style="width:28px;height:28px;"> Justice Juvenile Board <br>
        <img src="{% static 'map/pinmargerorange.png' %}" style="width:28px;height:28px;"> Child Welfare Centres <br>
        <img src="{% static 'map/pinmargergreen.png' %}" style="width:28px;height:28px;"> Abhay Kendra <br>
        
        <img src="{% static 'map/pinmargerpink.png' %}" style="width:28px;height:28px;"> DCPO <br>
        <img src="{% static 'map/pimarkerpurple.png' %}" style="width:18px;height:18px;"> Special Adoption Agency <br>
        <hr>
        <img src="{% static 'map/mh_police.png' %}" style="width:18px;height:18px;"> Police Stations <br>`
        

    return div;
};

legend.addTo(mymap);
    
    var DistrictSelected="";
    $("#district").change(function(){
        //document.getElementById('post-form').submit()
        //document.getElementById('cate').click()
        // document.getElementById('cate_submit').click();

        document.getElementsByName('district').forEach(e=>{
            e.value=$(this).val();
            console.log(e)
        })
        DistrictSelected = $(this).val();
        var optionsList;
        var htmlString = "";
    
        if(districtLayer){
            mymap.removeLayer(districtLayer)
        }
    
        var wms_layer;
        var data = fetchJSON("{% static 'data/districts_rev21june23.geojson' %}")
            .then(function(data) { 
        
            // do what you want to do with `data` here...
            data.features.forEach(function(feature) {
                //console.log(feature.properties.Block)
                if(DistrictSelected!=""){
                    //console.log(feature.properties)
                    if(feature.properties.district==DistrictSelected){
                        wms_layer = L.geoJson(feature.geometry)
                        wms_layer.addTo(mymap)
                        mymap.fitBounds(wms_layer.getBounds())
                    }
                }
                districtLayer = wms_layer;
            });
            
        });   
    
    });
        var sectionLayer;

      $('#section').change(function(){
        selectedSection = $(this).val()
        var wms_layer="";
        var htmlString="";
        var data = fetchJSON("{% static 'data/section.geojson' %}")
        .then(function(data) { 
    
        // do what you want to do with `data` here...
            data.features.forEach(function(feature) {
                console.log(feature.properties)
                if(selectedSection!=""){
                    //console.log(feature.properties)
                    if(feature.properties.Region==selectedSection){
                        wms_layer = L.geoJson(feature.geometry)
                        wms_layer.addTo(mymap)
                    }
                }
                sectionLayer = wms_layer;
            });               
        });   

        switch(selectedSection){
            case "Amravati":
                optionsList = Amravati;
                break;
            case "Aurangabad":
                optionsList = Aurangabad
                break;
            case "Mumbai":
                optionsList = Mumbai
                break;
            case "Nagpur":
                optionsList = Nagpur
                break;
            case "Pune":
                optionsList = Pune
                break;
            case "Nashik":
                optionsList = Nashik
                break;
        }

        if(optionsList!=undefined){
            htmlString = htmlString+"<option value=''> Select District </option>";
            for(var i = 1; i < optionsList.length; i++){
            htmlString = htmlString+"<option value='"+ optionsList[i] +"'>"+ optionsList[i] +"</option>";
            }
        }
        $("#district").html(htmlString);

    })


    /*
    $('#block_s').change(function(){
        putWMSLayertaluka();
        //document.getElementById('cate_submit').click();
        //document.getElementById('fs').click()
        //document.getElementById("post-form").submit();
    })
    */

    function fetchJSON(url) {
        return fetch(url)
          .then(function(response) {
            return response.json();
          });
      }


    function putWMSLayertaluka() {
    // clear_tallayer();

    if(talLayer){
        mymap.removeLayer(talLayer)
    }
    // var taluka = document.getElementById('block_s').value;

    var wms_layer;
    var data = fetchJSON("{% static 'data/talukas.geojson' %}")
        .then(function(data) { 
    
        // do what you want to do with `data` here...
        data.features.forEach(function(feature) {
            //console.log(feature.properties.Block)
            if(DistrictSelected!=""){
                if(feature.properties.Block==taluka && feature.properties.District==DistrictSelected){
                    //console.log(feature.geometry)
                    wms_layer = L.geoJson(feature.geometry)
                    wms_layer.addTo(mymap)
                }
            }else{
                if(feature.properties.Block==taluka){
                    //console.log(feature.geometry)
                    wms_layer = L.geoJson(feature.geometry)
                    wms_layer.addTo(mymap)
                }
            }
            talLayer=wms_layer;
        });
        
    });   
    
    }

    
function clearAll(){
    // alert("clicked clear all")
    DistrictSelected="";
    var opts = document.getElementsByClassName("optn")
    
    // alert(opts.length)
    for(var i=0;i<opts.length;i++){
        // alert(opts[i].checked)
        if(opts[i].checked)
            opts[i].checked=false
    }

    points.forEach(p=>{
        mymap.removeLayer(p)
    })
    points=[]
    if(districtLayer){
        mymap.removeLayer(districtLayer)
    }
    document.getElementById('district').value = "";
    if(talLayer){
        mymap.removeLayer(talLayer)
    }

    if(document.getElementById('mumbai_police_station').checked){
        document.getElementById('mumbai_police_station').dispatchEvent(new Event('change'))
    }
    if(document.getElementById('mumbai_police_jurisdiction').checked){
        document.getElementById('mumbai_police_jurisdiction').dispatchEvent(new Event('change'))
    }
    // if(circle)
        mymap.removeLayer(circle);
    mymap.setView([19.000, 74.999],7);
}

$(document).ready(
    $('#cc_form').submit(async function(e){
        e.preventDefault();
        var serializedData = $(this).serialize();
        //console.log('hjkhjh');

        $(document).ajaxStart(function () {
            document.getElementById('load').style.display='flex';
            //$("#load").show();
        }).ajaxStop(function () {
            document.getElementById('load').style.display='none';
            //$("#load").hide();
        });

        $.ajax({
            type:"POST",
            url: "{% url 'viewCCMap' %}",
            dataType: 'json',
            data: serializedData,
            success: function(data){
                //console.log(data["data"])
                //d = JSON.parse(data["data"])
                //data["d1"].forEach(e=>{
                //    console.log(e)
                //})
                d1 = JSON.parse(data["d1"])
                if(d1!="") {
                    plotData(d1,"child_care");
                    console.log("d1")
                }

                d2 = JSON.parse(data["d2"])
                console.log(d2)
                if(d2!="") {
                    plotData(d2,"jjb");
                }

                d3 = JSON.parse(data["d3"])
                if(d3!="") {
                    plotData(d3,"cwc");
                }

                d4 = JSON.parse(data["d4"])
                if(d4!="") {
                    plotData(d4,"ak");
                }

                d5 = JSON.parse(data["d5"])
                if(d5!="") {
                    plotData(d5,"saa");
                }
                
                d7 = JSON.parse(data["d7"])
                // console.log(d6)
                if(d7!="") {
                    plotData(d7,"dcpo");
                }
                d6 = JSON.parse(data["d6"])
                // console.log(d6)
                if(d6!="") {
                    plotData(d6,"mh_police");
                }
                
            }
        })
        console.log(' belowhjkhjh');
    }),
   
   
)

function removeOptn(a,b){
    // console.log(document.getElementById(a).getElementsByTagName('input'))
    for(var i=0;i<document.getElementById(a).getElementsByTagName('input').length;i++){
        if(document.getElementById(a).getElementsByTagName('input')[i].checked){
            document.getElementById(a).getElementsByTagName('input')[i].checked=false;
            // document.getElementById('cate_submit').click();
            break;
        }
    }
    document.getElementById('wsh').innerHTML+='<option value="'+a+'">'+b+'</option>';
    document.getElementById(a).remove()
    console.log(`${a} ${b}`)
    // document.getElementById('cate_submit').click();
    // sortSelect(document.getElementById('category_1'))
}

function plotData(d, optn){
    //for(x in d){
    //    console.log(d[x].fields.latitude)
    //}
    console.log("d is ",d)
    if(d==undefined || d == ""){
        alert("No results for this selection")
        clearAll()
    }
    // else
    //     alert("show for this selection")
    console.log(`pltdata called`)
    //replot()
    for(x in d){
        if(d[x].fields.latitude!=null && d[x].fields.longitude!=null){
            if(optn=="child_care"){
                var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon1});
                htm=""
                filename=""
                htm_1=""
                htm_2=""
                htm_3=""
                htm_4=""
                
                count=0
                for (const key in d[x].fields) {
                  count = count + 1;  
                  if(count<16 && count!=1 && count!=2 && count!=6 && count!=7 && count!=8 && count!=9 && count!=10 && count!=11 ){
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                    if(d[x].fields.frontgate_photo1_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str4 = htm_1.concat("' alt='image not found'></br>");
                        filename=d[x].fields.frontgate_photo1_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_1=" <img class = 'popupimage1' src='/static/map/CCI/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.livingroom_dormitory_photo2_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str5 = htm_2.concat("' alt='image not found'></br>");
                        filename=d[x].fields.livingroom_dormitory_photo2_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_2=" <img class = 'popupimage1' src='/static/map/CCI/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.open_campus_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str6 = htm_3.concat("' alt='image not found'></br>");
                        filename=d[x].fields.open_campus_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_3=" <img class = 'popupimage1' src='/static/map/CCI/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    // if(d[x].fields.room_dormitory_photo_id!=''){
                    //     // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                    //     // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                    //     filename=d[x].fields.room_dormitory_photo_id
                    //     // .split(".")[0] + ".jpg";
                    //     console.log("filename is : "+filename)
                    //     // alert(filename)
                    //     htm_4=" <img class = 'popupimage1' src='/static/map/CCI/".concat(filename).concat("'></br>");
                    //     var str7 = htm_4.concat("' alt='image not found'></br>");
                    //     // var str4 = htm_1.concat("' alt='image not found'></br>");
                    // }
                    if(d[x].fields.signature_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                        filename=d[x].fields.signature_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_5=" <img class = 'popupimage1' src='/static/map/CCI/".concat(filename).concat("'></br>");
                        var str8 = htm_5.concat("' alt='image not found'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");signature_photo5_id
                    }
                  } 
                 
                }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`<br>`+ `NamePlate-EntryDoor Photo`+htm_1+`<br>`+`Living Room/Dormitory Photo`+htm_2+`<br>`+`Open Campus Photo`+htm_3+`Sign Photo`+htm_5+`</div>`)

            }
            
            if(optn=="jjb"){
              var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon2});
                htm=""
                filename=""
                htm_1=""
                htm_2=""
                htm_3=""
                htm_4=""
                
                count=0
                for (const key in d[x].fields) {
                  count = count + 1;  
                  if(count<14 && count!=0 && count!=1 && count!=4 && count!=5 && count!=6  && count!=7 && count!=8 ){
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                    if(d[x].fields.nameplate_entrydoor_photo1_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str4 = htm_1.concat("' alt='image not found'></br>");
                        filename=d[x].fields.nameplate_entrydoor_photo1_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_1=" <img class = 'popupimage1' src='/static/map/JJB_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.sitting_arrangement_photo2_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str5 = htm_2.concat("' alt='image not found'></br>");
                        filename=d[x].fields.sitting_arrangement_photo2_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_2=" <img class = 'popupimage1' src='/static/map/JJB_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    
                    if(d[x].fields.signature_photo5_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                        filename=d[x].fields.signature_photo5_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_5=" <img class = 'popupimage1' src='/static/map/JJB_All_Data/".concat(filename).concat("'></br>");
                        var str8 = htm_5.concat("' alt='image not found'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");signature_photo5_id
                    }
                  } 
                 
                }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`<br>`+ `NamePlate-EntryDoor Photo`+htm_1+`<br>`+`Sitting Arrangement Photo`+htm_2+`<br>`+`Sign Photo`+htm_5+`</div>`)

            }
            
            if(optn=="cwc"){
                var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon3});
                htm=""
                filename=""
                htm_1=""
                htm_2=""
                htm_3=""
                htm_4=""
                
                count=0
                for (const key in d[x].fields) {
                  count = count + 1;  
                  if(count<15 && count!=1 && count!=4 && count!=5 && count!=6 && count!=7 && count!=8 && count!=9 ){
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                    if(d[x].fields.nameplate_entrydoor_photo1_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str4 = htm_1.concat("' alt='image not found'></br>");
                        filename=d[x].fields.nameplate_entrydoor_photo1_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_1=" <img class = 'popupimage1' src='/static/map/CWC_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.sitting_arrangement_photo2_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str5 = htm_2.concat("' alt='image not found'></br>");
                        filename=d[x].fields.sitting_arrangement_photo2_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_2=" <img class = 'popupimage1' src='/static/map/CWC_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.signature_photo5_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                        filename=d[x].fields.signature_photo5_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_5=" <img class = 'popupimage1' src='/static/map/CWC_All_Data/".concat(filename).concat("'></br>");
                        var str8 = htm_5.concat("' alt='image not found'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");signature_photo5_id
                    }
                  } 
                 
                }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`<br>`+ `NamePlate-EntryDoor Photo`+htm_1+`<br>`+`Sitting Arrangement Photo`+htm_2+`<br>`+`Sign Photo`+htm_5+`</div>`)

            }
            if(optn=="ak"){
              var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon4});
                htm=""
                filename=""
                htm_1=""
                htm_2=""
                htm_3=""
                htm_4=""
                
                count=0
                for (const key in d[x].fields) {
                  count = count + 1;  
                  if(count<11 && count!=0 && count!=1 && count!=6  && count!=7 && count!=8 && count!=9 && count!=10 ){
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                    if(d[x].fields.name_plate_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str4 = htm_1.concat("' alt='image not found'></br>");
                        filename=d[x].fields.name_plate_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_1=" <img class = 'popupimage1' src='/static/map/Abhay_Kendra_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.sitting_arrangement_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str5 = htm_2.concat("' alt='image not found'></br>");
                        filename=d[x].fields.sitting_arrangement_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_2=" <img class = 'popupimage1' src='/static/map/Abhay_Kendra_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    
                    if(d[x].fields.sign_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                        filename=d[x].fields.sign_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_5=" <img class = 'popupimage1' src='/static/map/Abhay_Kendra_All_Data/".concat(filename).concat("'></br>");
                        var str8 = htm_5.concat("' alt='image not found'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");signature_photo5_id
                    }
                  } 
                 
                }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;"><h5>Abhay Kendra Information</h5>`+htm+`<br>`+ `NamePlate-EntryDoor Photo`+htm_1+`<br>`+`Sitting Arrangement Photo`+htm_2+`<br>`+`Sign Photo`+htm_5+`</div>`)

            }
            if(optn=="saa"){
              var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon6});
                htm=""
                filename=""
                htm_1=""
                htm_2=""
                htm_3=""
                htm_4=""
                
                count=0
                for (const key in d[x].fields) {
                  count = count + 1;  
                  if(count<11 && count!=0  && count!=4 && count!=5 && count!=6  && count!=7 && count!=8 ){
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                    if(d[x].fields.nameplate_entrydoor_photo1_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str4 = htm_1.concat("' alt='image not found'></br>");
                        filename=d[x].fields.nameplate_entrydoor_photo1_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_1=" <img class = 'popupimage1' src='/static/map/SAA_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.sitting_arrangement_photo2_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str5 = htm_2.concat("' alt='image not found'></br>");
                        filename=d[x].fields.sitting_arrangement_photo2_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_2=" <img class = 'popupimage1' src='/static/map/SAA_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    
                    if(d[x].fields.signature_photo5_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                        filename=d[x].fields.signature_photo5_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_5=" <img class = 'popupimage1' src='/static/map/SAA_All_Data/".concat(filename).concat("'></br>");
                        var str8 = htm_5.concat("' alt='image not found'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");signature_photo5_id
                    }
                  } 
                 
                }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`<br>`+ `NamePlate-EntryDoor Photo`+htm_1+`<br>`+`Sitting Arrangement Photo`+htm_2+`<br>`+`Sign Photo`+htm_5+`</div>`)

            }
            if(optn=="dcpo"){
              var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon5});
                htm=""
                filename=""
                htm_1=""
                htm_2=""
                htm_3=""
                htm_4=""
                
                count=0
                for (const key in d[x].fields) {
                  count = count + 1;  
                  if(count<10 && count!=0 && count!=1 && count!=4 && count!=5 && count!=6  && count!=7 && count!=8 && count!=9 ){
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                    if(d[x].fields.name_plate_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str4 = htm_1.concat("' alt='image not found'></br>");
                        filename=d[x].fields.name_plate_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_1=" <img class = 'popupimage1' src='/static/map/DCPO_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    if(d[x].fields.sitting_arrangement_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        var str5 = htm_2.concat("' alt='image not found'></br>");
                        filename=d[x].fields.sitting_arrangement_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_2=" <img class = 'popupimage1' src='/static/map/DCPO_All_Data/".concat(filename).concat("'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");
                    }
                    
                    if(d[x].fields.sign_photo_id!=''){
                        // let img_name = feature.properties.img1.split(".")[0] + ".jpg";
                        // var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
                        
                        filename=d[x].fields.sign_photo_id
                        // .split(".")[0] + ".jpg";
                        console.log("filename is : "+filename)
                        // alert(filename)
                        htm_5=" <img class = 'popupimage1' src='/static/map/DCPO_All_Data/".concat(filename).concat("'></br>");
                        var str8 = htm_5.concat("' alt='image not found'></br>");
                        // var str4 = htm_1.concat("' alt='image not found'></br>");signature_photo5_id
                    }
                  } 
                 
                }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`<br>`+ `NamePlate-EntryDoor Photo`+htm_1+`<br>`+`Sitting Arrangement Photo`+htm_2+`<br>`+`Sign Photo`+htm_5+`</div>`)

            }
            if(optn=="mh_police"){
                var point = L.marker([d[x].fields.latitude,d[x].fields.longitude],{icon:icon7});
                htm=""
                for (const key in d[x].fields) {
                    if (d[x].fields.hasOwnProperty(key)) {
                      htm = htm+`${key}: ${d[x].fields[key]}<br>`
                    }
                  }
                point.bindPopup(`<div style="height:200px; overflow-y: scroll; background: white; color: black;">`+htm+`</div>`)
            }
            point.addTo(mymap)
            point.data=d[x].fields;
            
            points.push(point)

        }
    }
}

function replot(){
    points.forEach(p=>{
        mymap.removeLayer(p)
    })
    points=[]

}

var icon1 = L.icon({
    iconUrl:  "{% static 'map/pinmargerblue.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});
var icon2 = L.icon({
    iconUrl:  "{% static 'map/pinmargerred.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});
var icon3 = L.icon({
    iconUrl:  "{% static 'map/pinmargerorange.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});
var icon4 = L.icon({
    iconUrl:  "{% static 'map/pinmargergreen.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});
var icon5 = L.icon({
    iconUrl:  "{% static 'map/pinmargerpink.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});
var icon6 = L.icon({
    iconUrl:  "{% static 'map/pimarkerpurple.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});
var icon7 = L.icon({
    iconUrl:  "{% static 'map/mh_police.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
});

$locate = $('#locate'),
$body = $('body'),
$findNearest = $('#find-nearest'),
$setlocation = $('#setlocation'),
$setbuffer = $('#setbuffer')

let currentPos = null;
let marker = null;
let oldMarker = null;
let facilityLayer = new L.featureGroup();
let oldLayer = null;

$locate.on('click', function(e) {
    if (oldMarker) {
        mymap.removeLayer(oldMarker);
        oldMarker = null;
    }
    if (oldLayer) {
        mymap.removeLayer(oldLayer);
        oldLayer = null;
        facilityLayer = new L.featureGroup();
    }
    // $status.html('finding your location');
    if (!navigator.geolocation) {
        alert("<p>Sorry, your browser does not support Geolocation</p>");
        return;
    }
    $body.removeClass('loaded');
    navigator.geolocation.getCurrentPosition(success, error);
});                              

function success(position) {
    $body.addClass('loaded');
    currentPos = [position.coords.latitude, position.coords.longitude];
    mymap.setView(currentPos, 13);
    marker = L.marker(currentPos)
        .addTo(mymap)
        .bindTooltip("Your Location")
        .openTooltip();
    oldMarker = marker;

};
    // IF error IN FETCHING LOCATION
function error() {
    alert("Unable to retrieve your location");
    };
                                // SET LOCATION BUTTON
$setlocation.on('click', function(e) {
        mymap.on('dblclick', function(e) {
            currentPos = [e.latlng.lat, e.latlng.lng];
            if (oldMarker) {
                mymap.removeLayer(oldMarker);
                oldMarker = null;
            }
            if (oldLayer) {
                mymap.removeLayer(oldLayer);
                oldLayer = null;
                facilityLayer = new L.featureGroup();
            }

            
            marker = new L.marker(currentPos).addTo(mymap);
            oldMarker = marker;
        });
    })
    // SET BUFFER
var slider = document.getElementById("myRange");
var output = document.getElementById("demo");
output.innerHTML = slider.value;

slider.oninput = function() {
        output.innerHTML = this.value;

        //<!-- mymap.removeLayer(circle); -->
    }
    //////// BUFFER
var circle = new L.circle();
$setbuffer.on('click', function(e) {
    // if (oldhfbb) {
    //     mymap.removeLayer(circle);
    //     oldhfbb.forEach(layer => mymap.removeLayer(layer));
    //     // oldhfbb = null;
    //     healthFacilityInBB = null;
    //     healthFacility2 = null;
    //     healthFacility1 = null;
    // }
    mymap.removeLayer(circle);

    var radius = (output.innerHTML) * 1000;
    var circleCenter = currentPos;
    var circleOptions = {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.1
    }
    circle = new L.circle(circleCenter, radius, circleOptions);
    circle.addTo(mymap);
    // let keys = Object.keys(activatedHealthFacility);
    // let k = '';
    // keys.forEach((v, i) => {
    //         k = v;
    //         if (k === "Allo")
    //             querybufAllo(currentPos,k);
    //         if (k === 'Alt')
    //             querybufALt(currentPos,k);
    //         if (k === 'CHC')
    //             querybufCHC(currentPos,k);
    //         if (k === 'PHC')
    //             querybufPHC(currentPos,k);
    //         if (k === 'DCH' || k === 'DCHC' || k === 'DCCC')
    //             queryArog(currentPos,k);
    //         if (k === 'hospital' || k === 'subcenter' || k === 'mhu' || k === 'phc' || k === 'clinic' || k === 'phu' || k === 'ashu' || k === 'mobmedu' || k === 'hfwi' || k === 'mhi' || k === 'dc' || k === 'phrmcy' || k === 'optical' || k === 'delvry' || k === 'dropin' || k === 'dspnsry' || k === 'dropin' || k === 'othr')
    //             querybuf(currentPos,k);

    //     })
    //     //querybuf(currentPos);


});
var highlight = L.circleMarker()
    // let indstate = document.getElementById('indstate').value;



</script>
{% endblock %}
